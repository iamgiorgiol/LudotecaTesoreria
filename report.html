<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Report Movimenti</title>
<link rel="stylesheet" href="style.css">

<script src="https://www.gstatic.com/charts/loader.js"></script>

</head>
<body>

<div class="nav">
    <a href="index.html">Inserimento</a>
    <a href="report.html">Report</a>
    <a href="grafici.html">Grafici</a>
</div>

<div class="container">
    <h2>Report Entrate / Uscite</h2>
    <div id="tabella"></div>

    <button id="deleteButton" onclick="deleteSelectedRows()" disabled style="background-color: #f44336; margin-top: 20px;">
        Cancella Selezionati
    </button>
    <div id="deleteStatus" class="alert success" style="display: none;"></div>
    <div id="riepilogo-finanziario"></div>
</div>

<script>
// IMPORTANT: Re-paste the URL you got from deploying the Deletion Apps Script here.
const DELETE_API_URL = "YOUR_APPS_SCRIPT_WEB_APP_URL"; 
const SPREADSHEET_ID = "1AWL9t8xEYnSYMJFR4y7tAfMN2Tmxc07RtM0ZH3hYmbs";

google.charts.load('current', {'packages':['table']});
google.charts.setOnLoadCallback(drawTable);

function drawTable() {
    const query = new google.visualization.Query(
        `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json`
    );
    query.send(handleResponse);
}

// Function to handle fetching and displaying data
function handleResponse(response) {
    // Check for error in query response
    if (response.isError()) {
        document.getElementById('tabella').innerHTML = 'Errore nel caricamento dei dati: ' + response.getMessage();
        return;
    }
    
    const data = response.getDataTable();

    // Rinomino le colonne per leggibilità (Existing logic)
    data.setColumnLabel(0, "Timestamp");
    data.setColumnLabel(1, "Tipo");
    data.setColumnLabel(2, "Data");
    data.setColumnLabel(3, "Descrizione");
    data.setColumnLabel(4, "Valore (€)");
    data.setColumnLabel(5, "Categoria");

    // NEW LOGIC: Prepare data for deletion (add checkbox column)
    // The fix is here: we now define all columns (calculated + data) in one array.
    const view = prepareDataTableForDeletion(data);
    
    // 1. Draw the table
    const table = new google.visualization.Table(document.getElementById('tabella'));
    table.draw(view, {showRowNumber: false, width: '100%', height: '100%', allowHtml: true});

    // Add event listener to enable/disable the delete button
    document.getElementById('tabella').addEventListener('change', function(e) {
        if (e.target.type === 'checkbox') {
            const checkedBoxes = document.querySelectorAll('#tabella input[type="checkbox"]:checked');
            document.getElementById('deleteButton').disabled = checkedBoxes.length === 0;
        }
    });


    // 2. Calculate and Display Totals (Existing logic - uses the original 'data' table)
    let totalEntrate = 0;
    let totalUscite = 0;
    const valueColumnIndex = 4; // Column index for "Valore (€)" in the original 'data' table

    for (let i = 0; i < data.getNumberOfRows(); i++) {
        const tipo = data.getValue(i, 1);
        const valore = data.getValue(i, valueColumnIndex);

        if (tipo === 'entrata') {
            totalEntrate += parseFloat(valore); 
        } else if (tipo === 'uscita') {
            totalUscite += parseFloat(valore);
        }
    }

    const differenza = totalEntrate - totalUscite;
    const formatter = new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' });

    const summaryHtml = `
        <div style="margin-top: 30px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #f9f9f9;">
            <h3>Riepilogo Finanziario</h3>
            <p><strong>Totale Entrate:</strong> <span style="color: green;">${formatter.format(totalEntrate)}</span></p>
            <p><strong>Totale Uscite:</strong> <span style="color: red;">${formatter.format(totalUscite)}</span></p>
            <hr style="border-top: 1px dashed #ccc;">
            <p><strong>Saldo Finale:</strong> <span style="font-weight: bold; color: ${differenza >= 0 ? 'green' : 'red'}; font-size: 1.2em;">${formatter.format(differenza)}</span></p>
        </div>
    `;

    document.getElementById('riepilogo-finanziario').innerHTML = summaryHtml;
}

// CORRECTED FUNCTION: Prepares a new table view with a checkbox for deletion
function prepareDataTableForDeletion(data) {
    // Array to hold the final structure of the columns to display
    const columnsToDisplay = [];
    
    // Column 0 (New): The checkbox column (calculated using original data column 0: Timestamp)
    columnsToDisplay.push({
        type: 'string',
        label: 'Cancella',
        calc: function(data, row) {
            const timestamp = data.getValue(row, 0); 
            return `<input type="checkbox" data-timestamp="${timestamp}" style="width: auto; margin: 0;">`;
        }
    });

    // Columns 1 to N (Original data columns 1 to N: Tipo, Data, Descrizione, Valore, Categoria)
    // We start from index 1 because index 0 (Timestamp) is now used in the checkbox calculation.
    for (let i = 1; i < data.getNumberOfColumns(); i++) {
        columnsToDisplay.push(i);
    }
    
    // Create the DataView and set all columns simultaneously
    const view = new google.visualization.DataView(data);
    view.setColumns(columnsToDisplay); // This is the fixed and simplified part

    return view;
}


// NEW FUNCTION: Sends selected timestamps to the Apps Script API for deletion
async function deleteSelectedRows() {
    if (DELETE_API_URL === "YOUR_APPS_SCRIPT_WEB_APP_URL" || !DELETE_API_URL.startsWith('http')) {
        showDeleteStatus("ERRORE: Devi prima configurare e inserire la DELETE_API_URL dallo Step 2.", true);
        return;
    }

    const checkedBoxes = document.querySelectorAll('#tabella input[type="checkbox"]:checked');
    if (checkedBoxes.length === 0) return;

    const timestamps = Array.from(checkedBoxes).map(cb => cb.dataset.timestamp);
    
    showDeleteStatus(`Cancellazione di ${timestamps.length} movimenti in corso...`, false);
    document.getElementById('deleteButton').disabled = true;

    try {
        // Fetch is done with 'no-cors' mode as required by Google Apps Script web apps
        await fetch(DELETE_API_URL, {
            method: 'POST',
            mode: 'no-cors', 
            body: JSON.stringify({ timestamps: timestamps })
        });
        
        // Since it's 'no-cors', we assume success and reload.
        showDeleteStatus(`Cancellazione completata. Ricarico dati...`, false);
        setTimeout(drawTable, 2000); // Reload table after 2 seconds
    
    } catch (e) {
        showDeleteStatus("Errore di rete o connessione con il servizio di cancellazione.", true);
        document.getElementById('deleteButton').disabled = false;
        console.error("Deletion Error:", e);
    }
}

function showDeleteStatus(message, isError) {
    const statusDiv = document.getElementById('deleteStatus');
    statusDiv.innerHTML = message;
    statusDiv.className = isError ? 'alert error' : 'alert success';
    statusDiv.style.display = 'block';
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

</script>

</body>
</html>

