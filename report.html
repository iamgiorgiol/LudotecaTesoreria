<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Report Movimenti</title>
<link rel="stylesheet" href="style.css">

<script src="https://www.gstatic.com/charts/loader.js"></script>

</head>
<body>

<div class="nav">
    <a href="index.html">Inserimento</a>
    <a href="report.html">Report</a>
    <a href="grafici.html">Grafici</a>
</div>

<div class="container">
    <h2>Report Entrate / Uscite</h2>
    <div id="tabella"></div>
    <div id="riepilogo-finanziario"></div>
</div>

<script>
google.charts.load('current', {'packages':['table']});
google.charts.setOnLoadCallback(drawTable);

function drawTable() {
    const query = new google.visualization.Query(
        "https://docs.google.com/spreadsheets/d/1AWL9t8xEYnSYMJFR4y7tAfMN2Tmxc07RtM0ZH3hYmbs/gviz/tq?tqx=out:json"
    );
    query.send(handleResponse);
}

function handleResponse(response) {
    const data = response.getDataTable();

    // Rinomino le colonne per leggibilità (Existing code)
    data.setColumnLabel(0, "Timestamp");
    data.setColumnLabel(1, "Tipo");
    data.setColumnLabel(2, "Data");
    data.setColumnLabel(3, "Descrizione");
    data.setColumnLabel(4, "Valore (€)");
    data.setColumnLabel(5, "Categoria");

    // 1. Draw the table
    const table = new google.visualization.Table(document.getElementById('tabella'));
    // The width is set to 100% to fill the new 900px container width
    table.draw(data, {showRowNumber: false, width: '100%', height: '100%'});

    // 2. Calculate Totals (NEW LOGIC)
    let totalEntrate = 0;
    let totalUscite = 0;
    const valueColumnIndex = 4; // Column index for "Valore (€)"

    for (let i = 0; i < data.getNumberOfRows(); i++) {
        // We get the raw value from the column
        const tipo = data.getValue(i, 1);
        const valore = data.getValue(i, valueColumnIndex);

        if (tipo === 'entrata') {
            // Must convert to number for summing
            totalEntrate += parseFloat(valore); 
        } else if (tipo === 'uscita') {
            totalUscite += parseFloat(valore);
        }
    }

    const differenza = totalEntrate - totalUscite;

    // Helper to format currency
    const formatter = new Intl.NumberFormat('it-IT', {
        style: 'currency',
        currency: 'EUR',
    });

    // 3. Display Totals (NEW LOGIC)
    const summaryHtml = `
        <div style="margin-top: 30px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; background-color: #f9f9f9;">
            <h3>Riepilogo Finanziario</h3>
            <p><strong>Totale Entrate:</strong> <span style="color: green;">${formatter.format(totalEntrate)}</span></p>
            <p><strong>Totale Uscite:</strong> <span style="color: red;">${formatter.format(totalUscite)}</span></p>
            <hr style="border-top: 1px dashed #ccc;">
            <p><strong>Saldo Finale:</strong> <span style="font-weight: bold; color: ${differenza >= 0 ? 'green' : 'red'}; font-size: 1.2em;">${formatter.format(differenza)}</span></p>
        </div>
    `;

    document.getElementById('riepilogo-finanziario').innerHTML = summaryHtml;
}
</script>

</body>
</html>

