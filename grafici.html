<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Dashboard Grafica</title>
<link rel="stylesheet" href="style.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>

</head>
<body>

<div class="nav">
    <a href="index.html">Inserimento</a>
    <a href="report.html">Report</a>
    <a href="grafici.html">Grafici</a>
</div>

<div class="container">
    <h2>Dashboard Entrate / Uscite</h2>

    <canvas id="trend"></canvas>
    <canvas id="categorie"></canvas>
    <canvas id="totali"></canvas>
</div>

<script>
google.charts.load("current", {packages:["corechart"]});
google.charts.setOnLoadCallback(loadData);

function loadData() {
    let q = new google.visualization.Query(
        // Spreadsheet ID from your confirmed URL
        "https://docs.google.com/spreadsheets/d/1AWL9t8xEYnSYMJFR4y7tAfMN2Tmxc07RtM0ZH3hYmbs/gviz/tq?tqx=out:json"
    );
    q.send(handleResponse);
}

function handleResponse(res) {
    let table = res.getDataTable();

    let dati = [];
    for (let i = 0; i < table.getNumberOfRows(); i++) {
        dati.push({
            timestamp: table.getValue(i, 0),
            tipo: table.getValue(i, 1),
            data: table.getValue(i, 2),
            descrizione: table.getValue(i, 3),
            valore: parseFloat(table.getValue(i, 4)),
            categoria: table.getValue(i, 5)
        });
    }

    //-----------------------------------------------------
    // Grafico trend mensile: SEPARAZIONE ENTRATE/USCITE (NEW LOGIC)
    //-----------------------------------------------------
    let monthlyData = {};
    let monthLabels = new Set(); 
    
    dati.forEach(d => {
        if (!d.data) return;
        // Extracts YYYY-MM
        let m = d.data.substring(0, 7); 
        monthLabels.add(m);

        if (!monthlyData[m]) {
            monthlyData[m] = { entrate: 0, uscite: 0 };
        }

        if (d.tipo === 'entrata') {
            monthlyData[m].entrate += d.valore;
        } else if (d.tipo === 'uscita') {
            monthlyData[m].uscite += d.valore;
        }
    });
    
    // Sort months for chronological order
    const sortedMonths = Array.from(monthLabels).sort(); 
    
    // Prepare data arrays
    const entrateData = sortedMonths.map(month => monthlyData[month] ? monthlyData[month].entrate : 0);
    const usciteData = sortedMonths.map(month => monthlyData[month] ? monthlyData[month].uscite : 0);
    
    // Format month labels (e.g., "2023-11" -> "Nov 2023")
    const formattedLabels = sortedMonths.map(m => {
        const parts = m.split('-');
        const date = new Date(parts[0], parts[1] - 1, 1);
        return date.toLocaleDateString('it-IT', { year: 'numeric', month: 'short' });
    });

    // Draw the new Grouped Bar Chart
    new Chart(document.getElementById("trend"), {
        type: "bar", // Changed to bar chart
        data: {
            labels: formattedLabels, 
            datasets: [{
                label: "Entrate",
                data: entrateData,
                backgroundColor: "#4CAF50", // Green
            },
            {
                label: "Uscite",
                data: usciteData,
                backgroundColor: "#F44336", // Red
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    //-----------------------------------------------------
    // Grafico totali (Pie Chart - Current Year Totals)
    //-----------------------------------------------------
    const totEntrate = dati
        .filter(d => d.tipo === "entrata")
        .reduce((s,v)=>s+v.valore,0);

    const totUscite = dati
        .filter(d => d.tipo === "uscita")
        .reduce((s,v)=>s+v.valore,0);

    new Chart(document.getElementById("totali"), {
        type: "pie",
        data: {
            labels: ["Entrate", "Uscite"],
            datasets: [{
                data: [totEntrate, totUscite],
                backgroundColor: ["#4CAF50", "#F44336"]
            }]
        }
    });

    //-----------------------------------------------------
    // Grafico categorie (Bar Chart - Net Totals by Category)
    //-----------------------------------------------------
    let cat = {};
    dati.forEach(d => {
        cat[d.categoria] = (cat[d.categoria] || 0) + d.valore;
    });

    new Chart(document.getElementById("categorie"), {
        type: "bar",
        data: {
            labels: Object.keys(cat),
            datasets: [{
                label: "Per categoria",
                data: Object.values(cat),
                backgroundColor: "#2196F3"
            }]
        }
    });

}
</script>

</body>
</html>

